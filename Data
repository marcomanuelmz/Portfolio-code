// FORMULA 1 Copiamos los valores de la columna A de "Datos crudos"
function CopyPasteAFunction() {
  var app = SpreadsheetApp;
  var datoscrudosIFTTT = app.getActiveSpreadsheet().getSheetByName("Datos crudos");
  var lr = datoscrudosIFTTT.getLastRow()+1; // definimos la ultima fila + 1 porque empieza a contar de 0 
  
  for(i=1;i<lr;i++){
  var datoIFTTT = datoscrudosIFTTT.getRange(i, 1).getValue(); // tomamos los valores de datos crudos filas i columna 1 
  var DMIFTTT = app.getActiveSpreadsheet().getSheetByName("Datos masticados"); // seleccionamos la sheet a donde queremos llevar los datos 
  DMIFTTT.getRange(i+1, 1).setValue(datoIFTTT); // tomamos los datos de la sheet en la queremos tener los datos (DMIFTTT) (i + 1 para empezar en la segunda fila) en la primer columna y copiamos los datos
  }
}
 
// FORMULA 2 split los datos de la columna A de "Datos crudos" en "Datos masticados"
function splitAFunction() {
  var ss = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  ss.getRange("B2").setFormula('=split(A2,"at")');
  
  var LastRow = ss.getLastRow();
  var fillDownRange = ss.getRange(2, 2, LastRow-1);
  ss.getRange("B2").copyTo(fillDownRange);
}

// FORMULA 3 Copiamos los valores de la columna C de "Datos crudos"
function CopyPasteCFunction() {
  var app = SpreadsheetApp;
  var datoscrudosIFTTT = app.getActiveSpreadsheet().getSheetByName("Datos crudos");
  var lr = datoscrudosIFTTT.getLastRow()+1; 
  
  for(i=1;i<lr;i++){
  var datoIFTTT = datoscrudosIFTTT.getRange(i, 3).getValue();
  var DMIFTTT = app.getActiveSpreadsheet().getSheetByName("Datos masticados"); 
  DMIFTTT.getRange(i+1, 4).setValue(datoIFTTT); // 4 porque los copiamos en la columna D
  }
}

// FORMULA 4 split los datos de la columna C de "Datos crudos" en "Datos masticados"
function splitDFunction() {
  var ss = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  ss.getRange("E2").setFormula('=split(D2,", => [ ] { }")');
  
  var LastRow = ss.getLastRow();
  var fillDownRange = ss.getRange(2, 5, LastRow-1);
  ss.getRange("E2").copyTo(fillDownRange);
}

// FECHA y HORA
function fecha_horaFunction() {
  // FECHA
  var ss = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Datos masticados");
  ss.getRange("AT2").setFormula('=MID(L2,2,10)');
  
  var LastRow = ss.getLastRow();
  var fillDownRange = ss.getRange(2, 46, LastRow-1);
  ss.getRange("AT2").copyTo(fillDownRange);

  // HORA
  var ss = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  ss.getRange("AU2").setFormula('=MID(L2,13,8)*24');
  
  var LastRow = ss.getLastRow();
  var fillDownRange = ss.getRange(2, 47, LastRow-1);
  ss.getRange("AU2").copyTo(fillDownRange);
  
  // FECHA DATA STUDIO             NO ESTA ANDANDO PORQUE CAMBIAMOS EL FORMATO DE HORA A NUMERO HAY QUE DECIDIR QUE HACER
  var ss = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  ss.getRange("AV2").setFormula('=LEFT(AT2,4)&MID(AT2,6,2)&RIGHT(AT2,2)&LEFT(AU2,2)&MID(AU2,4,2)');
  
  var LastRow = ss.getLastRow();
  var fillDownRange = ss.getRange(2, 48, LastRow-1);
  ss.getRange("AV2").copyTo(fillDownRange);
}
//TURNO & D0 --------------------------------------------------------------------- x -----------------------------------------------------------
function Turno(){
  var ss = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Datos masticados");
  var lr = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Datos crudos").getLastRow()+2;
  var colHora = 47;
  var Turno1 = 8;
  var Turno2 = 16;
  var Turno3 = 24;
  var Turno4 = 0; // es turno 3 
  var colTurno = 49;
  var D0pulso = 17;
  var D0contador = 50;
  var D0tiempoproduccion = 51;
  var tiempoSTD = 0.05; //Tiempo en Hs
  var coltiempoSTD = 52;
  var D0Parada1 = 53;
  var colD0ParadaFinal = 54;
  var colD0ParadaAcum = 55;
  var colD0TiempoCal = 56;
 
  for(i=2;i<lr;i++){    
      var Hora = ss.getRange(i, colHora).getValue(); 
    if(Hora >= Turno1 && Hora < Turno2){
      var Turno_1 = ss.getRange(i, colTurno).setValue(1);
    }else if(Hora >= Turno2 && Hora < Turno3){
     var Turno_2 = ss.getRange(i, colTurno).setValue(2);
    } else if(Hora >= Turno4 && Hora < Turno1){
      var Turno_3 = ss.getRange(i, colTurno).setValue(3); 
    }}

// -----------------------------------------D0 --------------------------------------
// CONTADOR

  
  for(i=2;i<lr;i++){    
    var D0CA = ss.getRange(i, D0pulso).getValue(); // D0CA D0 Contador Actual 
    var D0CP = ss.getRange(i-1, D0pulso).getValue(); // D0CA D0 Contador Pasado (valor anterior)
      
    if(D0CA-D0CP>=0){
      var values = ss.getRange(i, D0contador).setValue(D0CA-D0CP);
    }else if(D0CA-D0CP<0){
      ss.getRange(i, D0contador).setValue(D0CA);
    }
// TIEMPO DE PRODUCCION   
    var D0TurnoActual = ss.getRange(i, colTurno).getValue();
    var D0TurnoAnterior = ss.getRange(i-1, colTurno).getValue();
    var HoraActual = ss.getRange(i, colHora).getValue();
    var HoraAnterior = ss.getRange(i-1, colHora).getValue();
    
    if(D0TurnoActual == D0TurnoAnterior){
      ss.getRange(i, D0tiempoproduccion).setValue(HoraActual-HoraAnterior);
  } else if(D0TurnoActual = 1){
      ss.getRange(i, D0tiempoproduccion).setValue(HoraActual-Turno1);
  }else if(D0TurnoActual = 2){
      ss.getRange(i, D0tiempoproduccion).setValue(HoraActual-Turno2);
  }else if(D0TurnoActual = 3){
      ss.getRange(i, D0tiempoproduccion).setValue(HoraActual-Turno3);
  } else {
    ss.getRange(i, D0tiempoproduccion).setValue(0);
  }

// Tiempo STD de Producción 

    var D0piezas = ss.getRange(i, D0contador).getValue();
    var D0piezasanterior = ss.getRange(i-1, D0contador).getValue();
    var D0tiempoSTD = ss.getRange(i, coltiempoSTD).setValue(D0piezas*tiempoSTD);
    
// Paradas
    //P1
    var D0tSTD = ss.getRange(i, coltiempoSTD).getValue();
    var D0tproduccion = ss.getRange(i, D0tiempoproduccion).getValue();
    var D0P1anterior = ss.getRange(i-1, D0Parada1).getValue();
    var tiempolimite = 0.055; // tiempo limite (Hs) entre el tiempo STD y el tiempo de producción
    if(D0tSTD - D0tproduccion > tiempolimite){
      ss.getRange(i, D0Parada1).setValue(0);     
    } else if (D0TurnoActual == D0TurnoAnterior && D0P1anterior < 0 ){
      ss.getRange(i, D0Parada1).setValue(D0tproduccion - D0tSTD + D0P1anterior);  
    }else if (D0piezas == 0 && D0piezasanterior > 0 || D0piezas >0){
      ss.getRange(i, D0Parada1).setValue(D0tproduccion - D0tSTD);  
    }else if (D0piezas == 0 && D0piezasanterior == 0){
      ss.getRange(i, D0P1).setValue(D0tproduccion - D0tSTD + D0P1anterior);
    }else {
      ss.getRange(i, D0Parada1).setValue(D0tproduccion - D0tSTD);  
    }
    // Parada Final
   var D0P1 = ss.getRange(i, D0Parada1).getValue();
   
    if(D0P1 <= 0){
      ss.getRange(i, colD0ParadaFinal).setValue(0);  
    }else if(D0P1>0 && D0TurnoActual == D0TurnoAnterior){
      ss.getRange(i, colD0ParadaFinal).setValue(D0P1);
    }else if (D0TurnoActual == 2 && D0TurnoAnterior == 1 ){
      ss.getRange(i, D0P1).setValue(HoraActual - Turno2);
    }else if (D0TurnoActual == 3 && D0TurnoAnterior == 2){
      ss.getRange(i, colD0ParadaFinal).setValue(HoraActual - Turno4);
    }else if (D0TurnoActual == 1 && D0TurnoAnterior == 3){
      ss.getRange(i, colD0ParadaFinal).setValue(HoraActual - Turno1);
    }else {
     ss.getRange(i, D0ParadaFinal).setValue(0);
    }
    // Paradas acumuladas del turno
    var D0ParadaFinal = ss.getRange(i, colD0ParadaFinal).getValue();
    var D0ParadaAcumAnterior = ss.getRange(i - 1, colD0ParadaAcum).getValue();
    
    if(D0TurnoActual == D0TurnoAnterior){
      ss.getRange(i, colD0ParadaAcum).setValue(D0ParadaFinal + D0ParadaAcumAnterior);
    } else {
      ss.getRange(i, colD0ParadaAcum).setValue(D0ParadaFinal);
    }
    
// Tiempos ----------------------------------------------------------------
    // Tiempo Calendario
    
    if(D0TurnoActual == 1){
      ss.getRange(i, colD0TiempoCal).setValue(HoraActual - Turno1);
    }else if(D0TurnoActual == 2){
      ss.getRange(i, colD0TiempoCal).setValue(HoraActual - Turno2);
    }else if(D0TurnoActual == 3){
      ss.getRange(i, colD0TiempoCal).setValue(HoraActual - Turno4); // el primer valor lo calcula mal! despues sigue bien VER!!!!!!!!!!!!!!!!!!!
    }
  }}
